#!/bin/sh
set -o errexit

# create registry container unless it already exists
reg_name='kind-registry'
reg_port='5002'
if [ "$(docker inspect -f '{{.State.Running}}' "${reg_name}" 2>/dev/null || true)" != 'true' ]; then
  docker run \
    -d --restart=always -p "127.0.0.1:${reg_port}:5000" --name "${reg_name}" \
    registry:2
fi

# create a cluster with the local registry enabled in containerd
cat <<EOF | kind create cluster --config=-
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
- role: worker
- role: worker
containerdConfigPatches:
- |-
  [plugins."io.containerd.grpc.v1.cri".registry.mirrors."localhost:${reg_port}"]
    endpoint = ["http://${reg_name}:5000"]
EOF

# connect the registry to the cluster network if not already connected
if [ "$(docker inspect -f='{{json .NetworkSettings.Networks.kind}}' "${reg_name}")" = 'null' ]; then
  docker network connect "kind" "${reg_name}"
fi

# Document the local registry
# https://github.com/kubernetes/enhancements/tree/master/keps/sig-cluster-lifecycle/generic/1755-communicating-a-local-registry
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: ConfigMap
metadata:
  name: local-registry-hosting
  namespace: kube-public
data:
  localRegistryHosting.v1: |
    host: "localhost:${reg_port}"
    help: "https://kind.sigs.k8s.io/docs/user/local-registry/"
  config: |
    apiVersion: v1
    clusters:
    - cluster:
        certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeU1EWXlNVEEwTlRnME4xb1hEVE15TURZeE9EQTBOVGcwTjFvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBT3U2CmwrU2c5bE1yNWdROVJMZy9JdXNSdXdIVkVhNkxTSG9qbDhoN0xqanV3OE93OWNQTFpadFJHVEFGY3pxbXJRdFUKZ1I3eU01MnMvOVZzOHZUa2hRUFM4NFhJT1c5ZUt0K3NUak51cTQ4VGdUQjhGKzBuSlhsWlhHM0N2N3JUOHBtYwp1b0pLMGZBRGE2dWsxOVlLOFNHTnAzdXNKOWM4MCt0V0UvOHdJTVlGcmR1WlNjTFMrVEVRa0FHOFBTY3VPMGN6CkFFTmZWSnBBbndRRmpEbUYxK1M3bWhrWHpCRXo5bmlMeHVNcHpKWUMxN1NSSlBlNVlrNGRLMkJ4UFRXdW9NakgKL2tyNXlRZnlZelhUWFl0OXA4NGNBZnZKZ2hJQU1wZDJlZ2RDRGM5Ui9vT3liVmF2RXg3QlBrZlA0T3k5WkZrbQpVTmViSW1uVFowZUJ1bnFPdDVVQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZDVlhzK2twenk4QlpTMG01S0tKcDJvUitxZzVNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBRHpmQTJUeDNzZHY0aTQ2NVIzRAplMzFXL0JqUEUrZ1BWZ0syRG96Ujhad2ZxaFJGOXVLSjgxUUxEZ25aL3BqejUxTTZGcTQwbGdTcTFqM1pyNm0vCkUxdmdCR1AyenByWEtWdDM5ZGhkaTExTFR1RTVBdGt1Z2RUZDNFS1Jmd3p3Mk93cDFkVFVJRzFXcXA5dHlxVzgKTW5BV0V5L3Rmb0NqYmZLYXhQMGEwR1BsZlNIVHZzZTRuK09EUk9EZkFSbktKZXNPTWJJU3VZSVNBZWd6b3E5cgpMQ29FL3VIdGIwZjRHOXhmUlNnZmpDQ21QaktrcGI2UkQ1K2l2a2ZyMGVlY0xOTm91UFk4MzZMMWRKeUxXQVhzCnJMeHFhNFI2cGZNYUVMeDAxMm1JL3JuY2FxR01mZDZqV2NINUQwbzdOcHFyQnJBMFpSZDlBSGVETm1OeU43dnMKVmxNPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
        server: https://127.0.0.1:40951
      name: kind-kind
    contexts:
    - context:
        cluster: kind-kind
        user: kind-kind
      name: kind-kind
    current-context: kind-kind
    kind: Config
    preferences: {}
    users:
    - name: kind-kind
      user:
        client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURJVENDQWdtZ0F3SUJBZ0lJU3MvdEpneXZzdzR3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TWpBMk1qRXdORFU0TkRkYUZ3MHlNekEyTWpFd05EVTRORGhhTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXE3cEFBWGhzK3I3ak1HNmsKWG02Q3NNY2E5Rmd0aFdSMTZaNDRtQnROV2NyenVtd1pnSVQvVHg4a2tacWxSbUJaZVlxZFJKaTVmSXhCMkFMTgoyVGpFVnNuY1FHYldQNHJ3UmI4QzZ3NGNCUDNKcnFTSWJKb2pUblExck5LRnNBeUNPRnRUMGpIRzdOU2RNRXRuCjQrZnFER1RoeFI2RzN6QlgrWDg1OTcwWVpiVTRYaC9mY1FRVjErQ2YxRGlrNkF1a0R1M0paNUdIdnhzYlZmNTIKdEF2eTlFaXJuQkdMSnQwYjQ2RDdiZXFCS0c2ZjB2YXBuMnhoY0gxS2N6NU1oaVBLM2dDQlJMQVc4R1d0ZTdTMwpnV3oxUmJkMGpwNzNkQjVkRFVWSlNFRVdQNy9VRGdqTXUwNGx3emovSnFBQlFkL2d1U1pROEN3azU3ZDJNL2pKCmxmTkZhd0lEQVFBQm8xWXdWREFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RBWURWUjBUQVFIL0JBSXdBREFmQmdOVkhTTUVHREFXZ0JRbFY3UHBLYzh2QVdVdEp1U2lpYWRxRWZxbwpPVEFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBU0VESFNQOWVBa0ZiZXFaVU1ENzBJMVQyWlB1TFgwMEZkQWplCnhzd0xPejVqUi85S2Z3WVJyaTZGU1ZibXByQzh6Qk4wMW81NVg5NnNSSDBIZ0M1bEFsM3V3VFY1RkV4NzJIcTEKOHFXdGRNR0t2SHF1QW5GQ1puRlYzVGtTTXVvU2VVZ1FMb1lNK1FSczN0K2FBeGlHN3JyYmlrTWF3VEtLZm1HOApwNjgvVVR5Sm44dkIyREtjQmhiU0I3dFVWZFl3eG1NNkRlMnF5czNBV0JxR2FGMWlpMUNsZENVYlVZdWpuZWlGCktUK29LeXZwQXRJUWQxdmpCazlFMVg5YnREVHdJdFpzb0tvN0JRTFMxQXcrTnYzM2QyTVdUUlM3Rm4zWEpWSEUKQlEyUjJ4Z25SNm5WMDQwdDdJU1k2TjRTVDVhK2xpQmoyczRFRUlFdks4OG9IZnpCUUE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
        client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb2dJQkFBS0NBUUVBcTdwQUFYaHMrcjdqTUc2a1htNkNzTWNhOUZndGhXUjE2WjQ0bUJ0Tldjcnp1bXdaCmdJVC9UeDhra1pxbFJtQlplWXFkUkppNWZJeEIyQUxOMlRqRVZzbmNRR2JXUDRyd1JiOEM2dzRjQlAzSnJxU0kKYkpvalRuUTFyTktGc0F5Q09GdFQwakhHN05TZE1FdG40K2ZxREdUaHhSNkczekJYK1g4NTk3MFlaYlU0WGgvZgpjUVFWMStDZjFEaWs2QXVrRHUzSlo1R0h2eHNiVmY1MnRBdnk5RWlybkJHTEp0MGI0NkQ3YmVxQktHNmYwdmFwCm4yeGhjSDFLY3o1TWhpUEszZ0NCUkxBVzhHV3RlN1MzZ1d6MVJiZDBqcDczZEI1ZERVVkpTRUVXUDcvVURnak0KdTA0bHd6ai9KcUFCUWQvZ3VTWlE4Q3drNTdkMk0vakpsZk5GYXdJREFRQUJBb0lCQUI5cmtZQnpYMFUxbmUzagpvSkZpbU9qdFZTSTE3QVpIRGtmeldobUNqVkdMajdLaFNyMDRHRnFLc1M4dTQyU1FCbTcxakxiYlZyelNFTTRNCkhVdk1WaWduQVBTTG5GRytBeDVQeDZIb1Qvb2QwVVB4K01BZUo2MllGNllLVXNtV1VGRXRiSlc5NDg2N1RCTmwKQ0pvcmVhaFE0UG9uRHJoUmFSZE9UdlhrRkUydllPbmV1Yk9uSlNxTWZiSzM5czMzeHJpTW1peWNYblFEbzZmaApQbWIrQzRiREZXZHU2dzMyY3hCeWFNdjQrM0oreE1LaFdTdFBlTXFFSUNGcXdKeWlIMm8vU0dSNGpyci9xMzNECnZZM0dYbFJZMTJIYU9rQUppYjZPQ2tSbTJ3L1ZROXc2cmk5dDM3WjU5WlhkWXZHV0ZMMmRpNUNLVTB4ZllXM2IKWlplViswa0NnWUVBMGZaTFRISDk2cTNzK0lXODJHdmd5NXV0b3dkeXlWY3pEaDJlQXoxRTlqcEZ4RzhEMXJndwo3YWlHUW03YWxvQnVaWUY5YWlzdjZuclNZOXFHV1V5UlF5WGpFYytlV1Fmc1Bkd2lwNmRFNUtackx1K0NkSjRmCmF5K2Z4SXc3emw1ZHJQL3c0aFB4Rnh1UVdNT1RlVFFmZm02cndySys5dXptaUR0bzNmakpLYzhDZ1lFQTBXSEEKNWpVMlJjV05tVEN2NXI4Rlo4aGloenVmV2RJcEFONkUvcjMzd21lQkkxNi9lR3YrUHpTd2dTTm5TbUJqL09NKwpvSGtHcnZzSExpQnE0TnN4VGVBOG9teG5ES3poT2VDejFHMEtxaWJHK1BEenBYQUR1MUQxZnplR0lySk5GbGxzCmVQZFdQbWZxcVNxRU9GQ0NwL0JnM2xkQzlEeDQ0NXlIWkhPYlBhVUNnWUJBTFVoVzFZRUhlcUkwVkt5a2VsVDcKNTFucnV4c2E3OHhyUkNKSVd6SDVFVmJCOUN6NE5OUy8wQU01eXlpRldEeG1TbTVMUldnZ0ErckxHc0IyQ3pGYgpsUGtUT0tMdUU3M2lLcWR0RjNPM2NDYlM4ZUt1UXFiWDNIYTVYU1Bxc0cxeHM4bXRVT3NnWlF4NkZVMitmbkFoCjlUSUxFUmZONGh1VkNKUEZSWVkzZ1FLQmdCSk0yTzlGOTFoaHk5NTN3dWdJQ2hEb0VyUi9JWTVZTC8xRGRaeE8KUGpsZmtvbmszaGRJV1JCdEtvQWUrQWdvSkpVVng0Ti9FSFo2dWtYdHoybVh2dGR2b2QwUVhIRmZLdEJFTTNOOQpsRkVLMHBrdmRod2ZqalB3LzRQKzlscFIreXJZNWdJc20vMFlXQW94RFIxZTdBeUJsZlhZNnFFdUorSzg2NWg4CkFqV0JBb0dBS3YwY2IxcytremZWclFlNXJESXFyZnFvVHhjNnhyZG1GVW1tZVQxSVZVcTRLUmRoVWkyV0gzd3UKKzh5M3FvU2Frd3JZMWxPSDdqaVlWKzZOR0QvZ3hobkgvM04xckFobk8yeWQycXRSc1RZelYwTFFxY1NQV1hZOQoyNFlzVk43aG5xK1UvUm5yM25yeitCU0lnNDFZN3MxQUFJSkZ4YmV1eW9TQUhDRmt4SUk9Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
EOF

